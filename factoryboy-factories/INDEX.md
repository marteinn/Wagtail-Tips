# Using Wagtail with Factory Boy

Wagtail uses [treebeard](https://github.com/tabo/django-treebeard) to handle hierarchy and therefore uses its path struture, by generating the path with a sequence we can in a easy way create test models.


### Page factory

```python
# Tested on Wagtail 1.7 and factory_boy 2.7.1

import factory
from wagtail.wagtailcore.models import Site, Page


class PageFactory(factory.DjangoModelFactory):
    class Meta:
        model = Page

    path = factory.Sequence(lambda x: '00010001{:04d}'.format(x+1))
    depth = 3
    numchild = 0
    live = True

    title = factory.Sequence(lambda x: 'page-title-{0}'.format(x))
```


#### Usage

And this is how you might use it in a unittest.

```python
import myapp.factories import PageFactory
page = PageFactory.create(title='mypage')

self.assertEquals(page.title, 'mypage')
```

Keep in mind that this approach put a bit more responsibility on you, since you need to manually both define depth and path (that is otherwise generated by wagtail when you use the built in page api).

```python
import myapp.factories import PageFactory
page = PageFactory.create(title='mypage')

sub_page = PageFactory.create(title='mypage', depth=page.depth+1, path='{}0001'.format(page.path))
```


### Site factory

Testing a site with a root page is also straightforward with a SubFactory.

```python
import factory
from wagtail.wagtailcore.models import Site

class SiteFactory(factory.DjangoModelFactory):
    class Meta:
        model = Site

    hostname = factory.Sequence(lambda x: 'host-{0}'.format(x))
    site_name = factory.Sequence(lambda x: 'Site {0}'.format(x))

    root_page = factory.SubFactory(PageFactory)
```

#### Usage

```python
site_a = SiteFactory.create(
    root_page=PageFactory.create(title='mypage', path='00010002')
)

self.assertEquals(site_a.root_page.title, 'mypage')
```


### Document factory

If you want to write tests for the Document model, just use the `get_document_model` when defining meta model.

```python
class DocumentFactory(factory.DjangoModelFactory):
    class Meta:
        model = get_document_model()

    title = factory.sequence(lambda x: 'document-title-{0}'.format(x))
    file = factory.django.FileField(filename='book.pdf')
```

#### Usage

```python
document = DocumentFactory.create()

my_recipe = MyRecipeFactory.create(
    file_attachment=document
)

response = self.client.get(reverse('recipe:attachment_download',
                                   kwargs={
                                        'recipe': my_recipe.pk,
                                   })

self.assertTrue(response['Content-Disposition'].endswith(
    document.filename))
```


### Image factory

```python
import factory
from wagtail.wagtailimages.tests.utils import get_test_image_file
from wagtail.wagtailimages.models import Image


class ImageFactory(factory.DjangoModelFactory):
    title = factory.sequence(lambda x: 'image-{0}'.format([x]))
    file = factory.LazyAttribute(lambda x: get_test_image_file())

    class Meta:
        model = Image
```
